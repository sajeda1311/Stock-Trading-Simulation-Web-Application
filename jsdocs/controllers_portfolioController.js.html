<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: controllers/portfolioController.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: controllers/portfolioController.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import transactionService from '../models/transaction.js'; // Assuming transaction service file is at this path

/**
 * Retrieves the portfolio for a specified user by aggregating their buy and sell transactions.
 *
 * @function getPortfolio
 * @async
 * @param {Object} req - Express request object
 * @param {Object} req.params - Request parameters
 * @param {string} req.params.username - The username of the player whose portfolio is being retrieved
 * @param {Object} res - Express response object
 * @returns {void} Returns a JSON response containing the user's aggregated portfolio data or an error message
 */
export const getPortfolio = async (req, res) => {
  const { username } = req.params; // Get username from the request params

  try {
    // Fetch all transactions for the given user
    const transactions = await transactionService.findTransactions({ playerId: username }); // Query by playerId

    console.log("Transactions: ", transactions); // Add this line to check the data

    // If no transactions are found, send a 404 response
    if (transactions.length === 0) {
      return res.status(404).json({ message: 'No transactions found for this user' });
    }

    /**
     * Aggregates data to form the user's portfolio by iterating over each transaction.
     * @typedef {Object} Portfolio
     * @property {number} quantity - Total quantity of stock owned
     * @property {number} totalInvested - Total amount invested in the stock
     * @property {number} totalSold - Total amount received from selling the stock
     */
    const portfolio = transactions.reduce((acc, transaction) => {
      const { stock, type, amount, totalInvested, totalSold } = transaction; // Include totalInvested and totalSold in destructuring

      // Initialize stock entry if not already present
      if (!acc[stock]) {
        acc[stock] = { quantity: 0, totalInvested: 0, totalSold: 0 };
      }

      // Update portfolio based on transaction type
      if (type === 'buy') {
        acc[stock].quantity += amount; // Increase quantity for buy transactions
        acc[stock].totalInvested += totalInvested; // Sum totalInvested for buy transactions
      } else if (type === 'sell') {
        acc[stock].quantity -= amount; // Decrease quantity for sell transactions
        acc[stock].totalSold += totalSold; // Sum totalSold for sell transactions
      }

      return acc; // Return accumulated portfolio
    }, {});

    // Return the aggregated portfolio data as a JSON response
    res.status(200).json(portfolio);
  } catch (error) {
    console.error("Error fetching portfolio:", error);
    res.status(500).json({ message: 'Error fetching portfolio' });
  }
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#after">after</a></li><li><a href="global.html#before">before</a></li><li><a href="global.html#buyStock">buyStock</a></li><li><a href="global.html#connectDB">connectDB</a></li><li><a href="global.html#connectToDB">connectToDB</a></li><li><a href="global.html#deleteTransaction">deleteTransaction</a></li><li><a href="global.html#findTransactions">findTransactions</a></li><li><a href="global.html#getCurrentHoldings">getCurrentHoldings</a></li><li><a href="global.html#getPortfolio">getPortfolio</a></li><li><a href="global.html#getTransactionsCollection">getTransactionsCollection</a></li><li><a href="global.html#insertTransaction">insertTransaction</a></li><li><a href="global.html#sellStock">sellStock</a></li><li><a href="global.html#updateTransaction">updateTransaction</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Wed Nov 06 2024 18:01:10 GMT-0330 (Newfoundland Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
